version: '3.8'

services:
  # 1. Falco Security Engine
  falco:
    image: falcosecurity/falco:latest
    container_name: falco
    privileged: true
    # Enable JSON output for programmatic consumption
    command: ["falco", "-o", "json_output=true", "-o", "json_include_output_fields_property=true", "-o", "webserver.enabled=false"]
    volumes:
      - ./falco/falco.yaml:/etc/falco/falco.yaml:ro
      - ./falco/custom_rules.yaml:/etc/falco/falco_rules.local.yaml:ro
      - /sys/kernel/tracing:/sys/kernel/tracing:ro 
      - /var/run/docker.sock:/host/var/run/docker.sock
      - /etc:/host/etc:ro
      - /proc:/host/proc:ro

  # 2. Prometheus Exporter (Converts Falco logs to Metrics)
  exporter:
    build: 
      context: .
      dockerfile: Dockerfile.backend
    container_name: hanabi-exporter
    command: python prometheus/exporter.py
    environment:
      - FALCO_CONTAINER=falco
      - PYTHONUNBUFFERED=1
    depends_on:
      - falco
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # Needs access to read Falco logs

  # 3. Hanabi Worker (Processes logs for HBT & Storage)
  hanabi_worker:
    build: 
      context: .
      dockerfile: Dockerfile.backend
    container_name: hanabi-worker
    command: python hanabi/worker.py
    environment:
      - FALCO_CONTAINER=falco
      - HBT_STORAGE_PATH=/app/data/hbt
      - DATA_DIR=/app/data
      - PYTHONUNBUFFERED=1
      - LOG_STORAGE_DEBUG=1
      - ALERTS_INGESTOR_URL=http://alerts-ingestor:9000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - shared_data:/app/data
    depends_on:
      - falco

  # 4. API Backend (FastAPI)
  api:
    build: 
      context: .
      dockerfile: Dockerfile.backend
    container_name: hanabi-api
    command: uvicorn api.app.main:app --host 0.0.0.0 --port 8000
    environment:
      - PROMETHEUS_URL=http://prometheus:9090
      - HBT_STORAGE_PATH=/app/data/hbt
      - DATA_DIR=/app/data
    volumes:
      - shared_data:/app/data
    depends_on:
      - prometheus
      - hanabi_worker

  # 5. Frontend (React + Nginx)
  web:
    build: ./web
    container_name: hanabi-web  
    ports:
      - "8081:80"
    depends_on:
      - api

  # 6. Prometheus (Metrics DB)
  prometheus:
    image: prom/prometheus:latest
    container_name: hanabi-prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    depends_on:
      - exporter

  # 8. Logs Ingestor (Falco -> logs DB)
  logs-ingestor:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: hanabi-logs-ingestor
    command: python ingestors/logs/main.py
    environment:
      - FALCO_CONTAINER=falco
      - DATA_DIR=/app/data
      - PYTHONUNBUFFERED=1
      - LOG_STORAGE_DEBUG=1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - shared_data:/app/data
    depends_on:
      - falco

  # 9. Alerts Ingestor (Hanabi Warning(T) -> alerts DB)
  alerts-ingestor:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: hanabi-alerts-ingestor
    command: uvicorn ingestors.alerts.main:app --host 0.0.0.0 --port 9000
    environment:
      - DATA_DIR=/app/data
      - PYTHONUNBUFFERED=1
    volumes:
      - shared_data:/app/data
    depends_on:
      - hanabi_worker

  # 10. Reducer (periodic alerts reduction -> incidents)
  reducer:
    build:
      context: .
      dockerfile: Dockerfile.reducer
    container_name: hanabi-reducer
    command: python reducer/service.py
    environment:
      - PROMETHEUS_URL=http://prometheus:9090
      - DATA_DIR=/app/data
      - REDUCER_INTERVAL_SECONDS=270
      - REDUCER_WINDOW_SECONDS=300
      - REDUCER_SIMILARITY=0.6
      - REDUCER_THREAT_THRESHOLD=60.0
      - REDUCER_MAX_PER_CLUSTER=1
      - PYTHONUNBUFFERED=1
    volumes:
      - shared_data:/app/data
    depends_on:
      - prometheus
      - alerts-ingestor

  # 11. Analyzer (LLM Analysis for Incidents)
  analyzer:
    build:
      context: .
      dockerfile: Dockerfile.analyzer
    container_name: hanabi-analyzer
    command: python analyzer/service.py
    environment:
      - DATA_DIR=/app/data
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - DEEPSEEK_ENDPOINT=https://api.deepseek.com
      - DEEPSEEK_MODEL=deepseek-chat
      - PYTHONUNBUFFERED=1
    volumes:
      - shared_data:/app/data
    depends_on:
      - logs-ingestor

  # 7. Grafana (Optional Visualization)
  # grafana:
  #   image: grafana/grafana-oss:latest
  #   ports:
  #     - "3000:3000"
  #   depends_on:
  #     - prometheus
  #   environment:
  #     - GF_SECURITY_ADMIN_PASSWORD=admin
  #   volumes:
  #     - ./grafana:/var/lib/grafana/dashboards

volumes:
  shared_data:
