<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="./logo.svg" />
    <script src="./runtime-config.js"></script>
    <title>基础设施攻击识别与响应</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module">
      async function verifyTokenBeforeLoad() {
        const baseUrl = (import.meta.env.BASE_URL || '/').replace(/\/$/, '')
        const authEnabled = window.__APP_CONFIG__?.authEnabled !== false
        const urlParams = new URLSearchParams(window.location.search)
        const token = urlParams.get('token')

        if (!authEnabled) {
          await import('/src/main.tsx')
          return
        }

        if (!token) {
          document.body.innerHTML = '<h2>未提供 token</h2>'
          return
        }

        try {
          const resp = await fetch(
            `${baseUrl}/clientsecurity/verifyToken?token=${encodeURIComponent(token)}`,
          )
          const json = await resp.json()

          if (json.success) {
            window.authUser = json.user
            const nextUrl = `${window.location.pathname}${window.location.hash}`
            window.history.replaceState({}, document.title, nextUrl)
            await import('/src/main.tsx')
          } else {
            document.body.innerHTML = `<h2>Token 验证失败：${json.error}</h2>`
          }
        } catch (e) {
          document.body.innerHTML = '<h2>无法验证 token</h2>'
        }
      }

      verifyTokenBeforeLoad()
    </script>
  </body>
</html>
